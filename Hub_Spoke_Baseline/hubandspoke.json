{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "hubspokeenv": {
            "type": "object",
            "defaultValue":{
                "hubvnetname":"LONHub-VNet",
                "prodvnetname":"LONProd-VNet",
                "drvnetname":"FRNKDR-VNet",
                "drspokevnetname": "FRNKDRSpoke-VNet",
                "prodHUBNSGName":"nsg-prod-hub-sn",
                "drHUBNSGName":"nsg-dr-hub-sn",
                "prodHubRTname":"rt-prod-hub-nva",
                "drHubRTname":"rt-dr-hub-nva"
            }
        }
    },
    "functions": [],
    "variables": {
        "peering-name-hub-to-prod-one": "hub-to-prod-one",
        "peering-name-prod-one-to-hub": "prod-one-to-hub",
        "peering-name-hub-to-dr-one": "hub-to-dr-one",
        "peering-name-dr-one-to-hub": "dr-one-to-hub",
        "peering-name-drhub-to-drspoke-one": "drhub-to-drspoke-one",
        "peering-name-drspoke-one-to-drhub": "drspoke-one-to-drhub"
    },
    "resources": [
        {
            "name": "[parameters('hubspokeenv').hubvnetname]",
            "type": "Microsoft.Network/virtualNetworks",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables/', parameters('hubspokeenv').prodHubRTname)]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"
            ],
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Approver": "David",
                "CostCenter": "123456",
                "Budget": "654321",
                "Env": "Mgmt"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.0.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "GatewaySubnet",
                        "properties": {
                            "addressPrefix": "192.168.0.0/27"
                        }
                    },
                    {
                        "name": "PA-MGMT",
                        "properties": {
                            "addressPrefix": "192.168.0.32/27",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                        
                    },
                    {
                        "name": "PA-Trsuted",
                        "properties": {
                            "addressPrefix": "192.168.0.64/27",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "PA-UnTrusted",
                        "properties": {
                            "addressPrefix": "192.168.0.96/27",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "Mgmt-SharedServices-01",
                        "properties": {
                            "addressPrefix": "192.168.0.128/27",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "Mgmt-SharedServices-02",
                        "properties": {
                            "addressPrefix": "192.168.0.160/27",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    }
                ]
            }
        },
        {
            "name": "[parameters('hubspokeenv').prodvnetname]",
            "type": "Microsoft.Network/virtualNetworks",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables/', parameters('hubspokeenv').prodHubRTname)]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"
            ],
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Approver": "David",
                "CostCenter": "123456",
                "Budget": "654321",
                "Env": "Prod"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.100.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "Prod-Subnet-01",
                        "properties": {
                            "addressPrefix": "192.168.100.0/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "Prod-Subnet-02",
                        "properties": {
                            "addressPrefix": "192.168.100.128/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').prodHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').prodHubRTname)]"
	                    }
                        }
                    }
                ]
            }
        },
        {
            "name": "[parameters('hubspokeenv').drvnetname]",
            "type": "Microsoft.Network/virtualNetworks",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables/', parameters('hubspokeenv').drHubRTname)]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"
            ],
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Approver": "David",
                "CostCenter": "123456",
                "Budget": "654321",
                "Env": "DR"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.200.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "DR-Subnet-01",
                        "properties": {
                            "addressPrefix": "192.168.200.0/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').drHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "DR-Subnet-02",
                        "properties": {
                            "addressPrefix": "192.168.200.128/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').drHubRTname)]"
	                    }
                        }
                    }
                ]
            }
        },
        {
            "name": "[parameters('hubspokeenv').drspokevnetname]",
            "type": "Microsoft.Network/virtualNetworks",
            "dependsOn": [
                "[resourceId('Microsoft.Network/routeTables/', parameters('hubspokeenv').drHubRTname)]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"
            ],
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "Approver": "David",
                "CostCenter": "123456",
                "Budget": "654321",
                "Env": "DR"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "192.168.220.0/24"
                    ]
                },
                "subnets": [
                    {
                        "name": "DR-Subnet-01",
                        "properties": {
                            "addressPrefix": "192.168.220.0/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').drHubRTname)]"
	                    }
                        }
                    },
                    {
                        "name": "DR-Subnet-02",
                        "properties": {
                            "addressPrefix": "192.168.220.128/25",
                            "networkSecurityGroup": {
                             "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('hubspokeenv').drHUBNSGName)]"   
                            },
                            "routeTable":{
	                        "id": "[resourceId('Microsoft.Network/routeTables', parameters('hubspokeenv').drHubRTname)]"
	                    }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').prodvnetname, '/', variables('peering-name-prod-one-to-hub'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').prodvnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').hubvnetname, '/', variables('peering-name-hub-to-prod-one'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').prodvnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').prodvnetname)]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').drvnetname, '/', variables('peering-name-dr-one-to-hub'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').hubvnetname, '/', variables('peering-name-hub-to-dr-one'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').hubvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').drspokevnetname, '/', variables('peering-name-drspoke-one-to-drhub'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drspokevnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('hubspokeenv').drvnetname, '/', variables('peering-name-drhub-to-drspoke-one'))]",
            "apiVersion": "2018-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drvnetname)]",
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drspokevnetname)]"
            ],
            "properties": {
                "allowVirtualNetworkAccess": true,
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "useRemoteGateways": false,
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/', parameters('hubspokeenv').drspokevnetname)]"
                }
            }
        },
        {
            "name": "[parameters('hubspokeenv').prodHUBNSGName]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "allow-onprem-inbound-rule01",
                        "properties": {
                            "description": "description",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "172.16.0.0/16",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-onprem-outbound-rule01",
                        "properties": {
                            "description": "description",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "172.16.0.0/16",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "name": "[parameters('hubspokeenv').prodHubRTname]",
            "type": "Microsoft.Network/routeTables",
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {},
            "properties": {
                "routes": [
                    {
                        "name": "r-Onprem-Route-NVA",
                        "properties": {
                            "addressPrefix": "172.16.0.0/16",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "192.168.0.5"
                        }
                    }
                ],
                "disableBgpRoutePropagation": true
            }
        },
        {
            "name": "[parameters('hubspokeenv').drHUBNSGName]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "allow-onprem-inbound-rule01",
                        "properties": {
                            "description": "description",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "172.16.0.0/16",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "allow-onprem-outbound-rule01",
                        "properties": {
                            "description": "description",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "172.16.0.0/16",
                            "access": "Allow",
                            "priority": 1000,
                            "direction": "Outbound"
                        }
                    }
                ]
            }
        },
        {
            "name": "[parameters('hubspokeenv').drHubRTname]",
            "type": "Microsoft.Network/routeTables",
            "apiVersion": "2020-11-01",
            "location": "[resourceGroup().location]",
            "tags": {},
            "properties": {
                "routes": [
                    {
                        "name": "r-Onprem-Route-NVA",
                        "properties": {
                            "addressPrefix": "172.16.0.0/16",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "192.168.0.5"
                        }
                    }
                ],
                "disableBgpRoutePropagation": true
            }
        }
        
    ],
    "outputs": {}
}