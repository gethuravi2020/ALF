{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dmzLocation": {
            "type": "string",
            "defaultValue": "UK South"
        },
        "drLocation": {
            "type": "string",
            "defaultValue": "Germany West Central"
        },        
        "hubSubscriptionId": {
            "type": "string",
            "defaultValue": "0e6352b0-80fc-48b4-b362-88af9c692b6e"
        },
        "coreSubscriptionId": {
            "type": "string",
            "defaultValue": "5837ab01-68c3-4fd7-9c86-b8bcef2c02f0"
        },
        "dmzhubvnetRg": {
            "type": "string",
            "defaultValue": "uks-dmz-prod-hub-rg"
        },
        "drhubvnetRg": {
            "type": "string",
            "defaultValue": "gwc-dmz-dr-hub-rg"
        },
        "coreprodvnetRg": {
            "type": "string",
            "defaultValue": "uks-core-prod-rg"
        },
        "drasrvnetRg": {
            "type": "string",
            "defaultValue": "gwc-dr-asr-rg"
        },
        "dmzhubvnetname": {
            "type": "string",
            "defaultValue": "uks-dmz-hub-vnet"
        },
        "drhubvnetname": {
            "type": "string",
            "defaultValue": "gwc-dr-hub-vnet"
        },
        "coreprodvnetname": {
            "type": "string",
            "defaultValue": "uks-core-prod-vnet"
        },
        "drasrvnetname": {
            "type": "string",
            "defaultValue": "gwc-dr-asr-vnet"
        },
        "uks-prod-core-nsg-name": {
            "type": "string",
            "defaultValue":"uks-prod-core-nsg"
        },
        "gwc-dr-asr-nsg-name": {
            "type": "string",
            "defaultValue":"gwc-dr-asr-nsg"
        },
        "uks-dmz-hub-nsg-name": {
            "type": "string",
            "defaultValue":"uks-dmz-hub-nsg"
        },
        "gwc-dr-hub-nsg-name": {
            "type": "string",
            "defaultValue":"gwc-dr-hub-nsg"
        },
        "rt-exphub-uks-hub-nva": {
            "type": "string",
            "defaultValue":"rt-exphub-uks-hub-nva"
        },
        "rt-exphub-gwc-hub-nva": {
            "type": "string",
            "defaultValue":"rt-exphub-gwc-hub-nva"
        },
        "rt-ukcore-uks-prod": {
            "type": "string",
            "defaultValue":"rt-ukcore-uks-prod"
        },
        "rt-ukcore-gwc-dr": {
            "type": "string",
            "defaultValue":"rt-ukcore-gwc-dr"
        },
        "workspaceName": {
            "type": "string",
            "defaultValue":"uks-az-law-p1"
        },
        "workspaceResourceGroup": {
            "type": "string",
            "defaultValue": "uks-dmz-prod-hub-rg"
        },
        "workspaceSubscriptionID": {
            "type": "string",
            "defaultValue": "0e6352b0-80fc-48b4-b362-88af9c692b6e"
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue":"lonhubukssadiag"
        },
        "tags-prod": {
            "type": "object",
            "defaultValue": {}
        },
        "tags-dr": {
            "type": "object",
            "defaultValue": {}
        }
    },
    "functions": [],
    "variables": {
        "peering-name-ukshub-to-ukscore": "peering-ukshub-to-ukscore",
        "peering-name-ukscore-to-ukshub": "peering-ukscore-to-ukshub",
        "peering-name-ukshub-to-gwchub": "peering-ukshub-to-gwchub",
        "peering-name-gwchub-to-ukshub": "peering-gwchub-to-ukshub",
        "peering-name-ukscore-to-gwcasr": "peering-ukscore-to-gwcasr",
        "peering-name-gwcasr-to-ukscore": "peering-gwcasr-to-ukscore",
        "peering-name-gwchub-to-gwcasr": "peering-gwchub-to-gwasr",
        "peering-name-gwcasr-to-gwchub": "peering-gwcasr-to-gwchub"
    },
    "resources": [
    {
        "name": "DmzHubVnetDeployment",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "subscriptionId":"[parameters('hubSubscriptionId')]",
        "resourceGroup": "[parameters('dmzhubvnetRg')]",
        "tags": "[parameters('tags-prod')]",
        "properties": {
            "mode": "Incremental",
            "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "variables": {},
                "resources": [
                    {
                        "name": "[parameters('dmzhubvnetname')]",
                        "type": "Microsoft.Network/virtualNetworks",
                        "apiVersion": "2020-11-01",
                        "location": "[parameters('dmzLocation')]",                       
                        "tags": "[parameters('tags-prod')]",
                        "properties": {
                            "addressSpace": {
                                "addressPrefixes": [
                                    "10.8.32.0/19"
                                ]
                            },
                            "subnets": [
                                {
                                    "name": "GatewaySubnet",
                                    "properties": {
                                        "addressPrefix": "10.8.32.0/27"                                        
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-sn01",
                                    "properties": {
                                        "addressPrefix": "10.8.32.32/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                          
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-mgmt-sn02",
                                    "properties": {
                                        "addressPrefix": "10.8.32.64/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                            
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-pa-trust-sn03",
                                    "properties": {
                                        "addressPrefix": "10.8.32.96/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                          
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-pa-untrust-sn04",
                                    "properties": {
                                        "addressPrefix": "10.8.32.128/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                           
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-pa-ha2-sn05",
                                    "properties": {
                                        "addressPrefix": "10.8.32.160/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                            
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-ics-internal-sn06",
                                    "properties": {
                                        "addressPrefix": "10.8.32.192/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                           
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-ics-external-sn07",
                                    "properties": {
                                        "addressPrefix": "10.8.32.224/27",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                            
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-ics-tunnel-sn08",
                                    "properties": {
                                        "addressPrefix": "10.8.36.0/22",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                           
                                    }
                                },
                                {
                                    "name": "uks-dmz-hub-vnet-ics-tunnel-sn09",
                                    "properties": {
                                        "addressPrefix": "10.8.40.0/22",
                                        "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-dmz-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-uks-hub-nva'))]"
                                        }                            
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "type": "Microsoft.Resources/deploymentScripts",
                        "apiVersion": "2020-10-01",
                        "kind": "AzurePowerShell",
                        "name": "WaitSection",
                        "tags":"[parameters('tags-prod')]",
                        "location": "[parameters('dmzLocation')]",
                        "dependsOn": [
                            "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('dmzhubvnetname'))]"
                        ],
                        "properties": {
                            "azPowerShellVersion": "3.0",
                            "scriptContent": "start-sleep -Seconds 15",
                            "cleanupPreference": "Always",
                            "retentionInterval": "PT1H",
                            "storageAccountSettings": {
                                "storageAccountName": "[parameters('storageAccountName')]",
                                "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                            }
                        }
                    },
                    {
                        "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings",
                        "apiVersion": "2021-05-01-preview",
                        "name": "[concat(parameters('dmzhubvnetname'), '/Microsoft.Insights/', parameters('dmzhubvnetname'),'-diagnostics')]",
                        "dependsOn": ["WaitSection"],
                        "properties": {
                            "workspaceId": "[concat('/subscriptions/', parameters('workspaceSubscriptionID'), '/resourceGroups/', parameters('workspaceResourceGroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",                           
                            "metrics": [
                                {
                                    "category": "AllMetrics",
                                    "enabled": true
                                }
                            ],
                            "logs":[
                                {
                                    "categoryGroup":"allLogs",
                                    "enabled":true
                                }
                            ]
                        }
                    },                    
                    {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "dependsOn": ["WaitSection"],
                            "name": "[concat(parameters('dmzhubvnetname'), '/', variables('peering-name-ukshub-to-ukscore'))]",
                            "apiVersion": "2018-08-01",
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,                                
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('coreprodvnetname'))]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "dependsOn": ["WaitSection"],
                            "name": "[concat(parameters('dmzhubvnetname'), '/', variables('peering-name-ukshub-to-gwchub'))]",
                            "apiVersion": "2018-08-01",
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drhubvnetname'))]"
                                }
                            }
                        }
                ],
                "outputs": {}
            }
        }
    },
    {
       "name": "DmzDrVnetDeployment",
       "type": "Microsoft.Resources/deployments",
       "apiVersion": "2021-04-01",
       "subscriptionId":"[parameters('hubSubscriptionId')]",     
       "resourceGroup":"[parameters('drhubvnetRg')]",
       "tags":"[parameters('tags-dr')]",
       "properties": {
           "mode": "Incremental",
           "template": {
               "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
               "contentVersion": "1.0.0.0",
               "variables": {},
               "resources": [
                {
                "name": "[parameters('drhubvnetname')]",
                "type": "Microsoft.Network/virtualNetworks",
                "apiVersion": "2020-11-01",
                "location": "[parameters('drLocation')]",                    
                "tags": "[parameters('tags-dr')]",
                "properties": {
                    "addressSpace": {
                        "addressPrefixes": [
                            "10.8.96.0/19"
                        ]
                    },
                    "subnets": [
                        {
                            "name": "GatewaySubnet",
                            "properties": {
                                "addressPrefix": "10.8.96.0/27"
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-sn01",
                            "properties": {
                                "addressPrefix": "10.8.96.32/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                               
                            }
                        },
                        
                        {
                            "name": "gwc-dr-hub-vnet-mgmt-sn02",
                            "properties": {
                                "addressPrefix": "10.8.96.64/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                            
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-pa-trust-sn03",
                            "properties": {
                                "addressPrefix": "10.8.96.96/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                           
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-pa-untrust-sn04",
                            "properties": {
                                "addressPrefix": "10.8.96.128/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                            
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-ps-mgmt-sn05",
                            "properties": {
                                "addressPrefix": "10.8.96.160/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                            
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-ics-internal-sn06",
                            "properties": {
                                "addressPrefix": "10.8.96.192/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                            
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-ics-external-sn07",
                            "properties": {
                                "addressPrefix": "10.8.96.224/27",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                           
                            }
                        },
                        {
                            "name": "gwc-dr-hub-vnet-ps-tunnel-sn08",
                            "properties": {
                                "addressPrefix": "10.8.100.0/22",
                                "networkSecurityGroup": {
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-hub-nsg-name'))]"
                                        },
                                        "routeTable":{
                                            "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-exphub-gwc-hub-nva'))]"
                                        }                           
                                    }
                                }
                            ]
                        }
                },
                {
                        "type": "Microsoft.Resources/deploymentScripts",
                        "apiVersion": "2020-10-01",
                        "kind": "AzurePowerShell",
                        "name": "WaitSection",
                        "location": "[parameters('drLocation')]",
                        "tags":"[parameters('tags-dr')]",
                        "dependsOn": [
                            "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drhubvnetname'))]"
                        ],
                        "properties": {
                            "azPowerShellVersion": "3.0",
                            "scriptContent": "start-sleep -Seconds 15",
                            "cleanupPreference": "Always",
                            "retentionInterval": "PT1H",
                            "storageAccountSettings": {
                                "storageAccountName": "[parameters('storageAccountName')]",
                                "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                            }
                        }
                    },
                    {
                        "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings",
                        "apiVersion": "2021-05-01-preview",
                        "name": "[concat(parameters('drhubvnetname'), '/Microsoft.Insights/', parameters('drhubvnetname'),'-diagnostics')]",
                        "dependsOn": ["WaitSection"],
                        "properties": {
                            "workspaceId": "[concat('/subscriptions/', parameters('workspaceSubscriptionID'), '/resourceGroups/', parameters('workspaceResourceGroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",                           
                            "metrics": [
                                {
                                    "category": "AllMetrics",
                                    "enabled": true
                                }
                            ],
                            "logs":[
                                {
                                    "categoryGroup":"allLogs",
                                    "enabled":true
                                }
                            ]
                        }
                    },
                    {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('drhubvnetname'), '/', variables('peering-name-gwchub-to-gwcasr'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('coreSubscriptionId'), parameters('drasrvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drasrvnetname'))]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('drhubvnetname'), '/', variables('peering-name-gwchub-to-ukshub'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('dmzhubvnetname'))]"
                                }
                            }
                        }

               ],
               "outputs": {}
           }
       }
   },
   {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "CoreProdVnetDeployment",     
            "subscriptionId": "[parameters('coreSubscriptionId')]",
            "resourceGroup": "[parameters('coreprodvnetRg')]",
            "tags":"[parameters('tags-prod')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [        
                        {
                            "name": "[parameters('coreprodvnetname')]",
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2020-11-01",
                            "location": "[parameters('dmzLocation')]",
                            "tags":"[parameters('tags-prod')]",                          
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "10.8.0.0/21"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "uks-core-prod-vnet-vm-sn01",
                                        "properties": {
                                            "addressPrefix": "10.8.0.0/22",
                                            "networkSecurityGroup": {
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-prod-core-nsg-name')))]"
                                        },
                                        "routeTable":{
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-ukcore-uks-prod')))]"
                                        }     
                                        }
                                    },
                                    {
                                        "name": "uks-core-prod-vnet-ics-internal-sn02",
                                        "properties": {
                                            "addressPrefix": "10.8.4.0/28",
                                            "networkSecurityGroup": {
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-prod-core-nsg-name')))]"
                                        },
                                        "routeTable":{
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-ukcore-uks-prod')))]"
                                        }     
                                        }
                                    },
                                    {
                                        "name": "uks-core-prod-vnet-ics-external-sn03",
                                        "properties": {
                                            "addressPrefix": "10.8.4.16/28",
                                            "networkSecurityGroup": {
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('uks-prod-core-nsg-name')))]"
                                        },
                                        "routeTable":{
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-ukcore-uks-prod')))]"
                                        }     
                                        }
                                    }
                                ]
                            }
                        },
                        {
                        "type": "Microsoft.Resources/deploymentScripts",
                        "apiVersion": "2020-10-01",
                        "kind": "AzurePowerShell",
                        "name": "WaitSection",
                        "tags":"[parameters('tags-prod')]",
                        "location": "[parameters('dmzLocation')]",
                        "dependsOn": [
                            "[resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('coreprodvnetname'))]"
                        ],
                        "properties": {
                            "azPowerShellVersion": "3.0",
                            "scriptContent": "start-sleep -Seconds 15",
                            "cleanupPreference": "Always",
                            "retentionInterval": "PT1H",
                            "storageAccountSettings": {
                                "storageAccountName": "[parameters('storageAccountName')]",
                                "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                                }
                            }
                        },
                        {
                        "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings",
                        "apiVersion": "2021-05-01-preview",
                        "name": "[concat(parameters('coreprodvnetname'), '/Microsoft.Insights/', parameters('coreprodvnetname'),'-diagnostics')]",
                        "dependsOn": ["WaitSection"],
                        "properties": {
                            "workspaceId": "[concat('/subscriptions/', parameters('workspaceSubscriptionID'), '/resourceGroups/', parameters('workspaceResourceGroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",                           
                            "metrics": [
                                {
                                    "category": "AllMetrics",
                                    "enabled": true
                                }
                            ],
                            "logs":[
                                {
                                    "categoryGroup":"allLogs",
                                    "enabled":true
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('coreprodvnetname'), '/', variables('peering-name-ukscore-to-ukshub'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('hubSubscriptionId'), parameters('dmzhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('dmzhubvnetname'))]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('coreprodvnetname'), '/', variables('peering-name-ukscore-to-gwcasr'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('coreSubscriptionId'), parameters('drasrvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drasrvnetname'))]"
                                }
                            }
                        }

                     ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "DrAsrVnetDeplyoment",     
            "subscriptionId": "[parameters('coreSubscriptionId')]",
            "resourceGroup": "[parameters('drasrvnetRg')]",
            "tags":"[parameters('tags-dr')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [        
                        {
                            "name": "[parameters('drasrvnetname')]",
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2020-11-01",
                            "location": "[parameters('drLocation')]",
                            "tags":"[parameters('tags-dr')]",                            
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "10.8.64.0/21"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "gwc-dr-asr-vnet-vm-sn01",
                                        "properties": {
                                            "addressPrefix": "10.8.64.0/22",
                                            "networkSecurityGroup": {
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('drasrvnetRg'), 'Microsoft.Network/networkSecurityGroups',parameters('gwc-dr-asr-nsg-name')))]"
                                        },
                                        "routeTable":{
                                            "id": "[toLower(resourceId(parameters('coreSubscriptionId'), parameters('drasrvnetRg'), 'Microsoft.Network/routeTables',parameters('rt-ukcore-gwc-dr')))]"
                                        }  
                                        }
                                    }
                                ]
                            }
                        },
                        {
                        "type": "Microsoft.Resources/deploymentScripts",
                        "apiVersion": "2020-10-01",
                        "kind": "AzurePowerShell",
                        "name": "WaitSection",
                        "location": "[parameters('drLocation')]",
                        "tags":"[parameters('tags-dr')]",
                        "dependsOn": [
                            "[resourceId(parameters('coreSubscriptionId'), parameters('drasrvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drasrvnetname'))]"
                        ],
                        "properties": {
                            "azPowerShellVersion": "3.0",
                            "scriptContent": "start-sleep -Seconds 15",
                            "cleanupPreference": "Always",
                            "retentionInterval": "PT1H",
                            "storageAccountSettings": {
                                "storageAccountName": "[parameters('storageAccountName')]",
                                "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value]"
                                }
                            }
                        },
                        {
                        "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings",
                        "apiVersion": "2021-05-01-preview",
                        "name": "[concat(parameters('drasrvnetname'), '/Microsoft.Insights/', parameters('drasrvnetname'),'-diagnostics')]",
                        "dependsOn": ["WaitSection"],
                        "properties": {
                            "workspaceId": "[concat('/subscriptions/', parameters('workspaceSubscriptionID'), '/resourceGroups/', parameters('workspaceResourceGroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",                           
                            "metrics": [
                                {
                                    "category": "AllMetrics",
                                    "enabled": true
                                }
                            ],
                            "logs":[
                                {                                    
                                    "categoryGroup":"allLogs",
                                    "enabled":true
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('drasrvnetname'), '/', variables('peering-name-gwcasr-to-gwchub'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],
                            "properties": {
                                "allowVirtualNetworkAccess": true,
                                "allowForwardedTraffic": true,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('hubSubscriptionId'), parameters('drhubvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('drhubvnetname'))]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "name": "[concat(parameters('drasrvnetname'), '/', variables('peering-name-gwcasr-to-ukscore'))]",
                            "apiVersion": "2018-08-01",
                            "dependsOn": ["WaitSection"],                            
                            "properties": {
                                "allowVirtualNetworkAccess": false,
                                "allowForwardedTraffic": false,
                                "allowGatewayTransit": false,
                                "useRemoteGateways": false,
                                "remoteVirtualNetwork": {
                                    "id": "[resourceId(parameters('coreSubscriptionId'), parameters('coreprodvnetRg'), 'Microsoft.Network/virtualNetworks',parameters('coreprodvnetname'))]"
                                }
                            }
                        }

                    ]
                }
            }
        }        
                    
    ],
    "outputs": {}
}



