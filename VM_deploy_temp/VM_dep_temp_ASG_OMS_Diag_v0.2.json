{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vmname": {
            "type": "string",
            "defaultValue": "vm003"
            },
        "storageaccount": {
            "type": "string",
            "defaultValue": "dstg009"
            },
        "bootdigstgaccount": {
            "type": "string",
            "defaultValue": "bboot555"
        },
        "bootdigstgRG": {
            "type": "string",
            "defaultValue": "bootstg001"
        },
        "virtualnetwork": {
            "type": "string",
            "defaultValue": "testrg-vnet"
            },
        "applicationSecurityGroups": {
            "type": "string",
            "defaultValue": "asgp001"
            },
        "subnetname": {
                "type": "string",
                "defaultValue": "default"
                },
        "vmsize": {
                    "type": "string",
                    "defaultValue": "Standard_E2bds_v5"
                 },
        "OSDiskType": {
                "type": "string",
                "defaultValue": "StandardSSD_LRS",
                "allowedValues": [
                    "Standard_LRS",
                    "StandardSSD_LRS",
                    "Premium_LRS"
                ]
            },
            "numberofDatadisks": {
                "type": "int",
                "defaultValue":1,
                "minValue":0,
                "maxValue":64
            },
            "dataDisktype": {
                "type": "string",
                "defaultValue": "StandardSSD_LRS",
                "allowedValues":[
                    "Standard_LRS",
                    "StandardSSD_LRS",
                    "Premium_LRS"
                ]
            },
            "datadiskSize": {
                "type": "int",
                "defaultValue":128,
                "minValue":1,
                "maxValue":32767                
            },
            "dataDiskHostCaching": {
                "type": "string",
                "defaultValue": "None",
                "allowedValues": [
                    "None",
                    "Readonly",
                    "ReadWrite"
                ]
            },
        "workspaceid": {
            "type": "string",
            "defaultValue": "e707d6bc-20d0-4a6d-982e-ffe1d1a28fd8"
            },
         "workspacekey": {
                "type": "string",
                "defaultValue": "yd5HdKGpT6bDnPZXBEd5afTdp35zI1oxsLtUZiO22FcLjY7zE58QNTrEV4b7fFg7+oWPSpBhEJnuuUKwZtIaFw=="
            },
        "Zone": {
             "type": "string",
             "defaultValue": "1",
             "allowedValues": [
                "1",
                "2",
                "3"
         ]
          },
      "OperatingSystem": {
      "type": "string",
      "defaultValue": "2019-datacenter-gensecond",
      "allowedValues": [
        "2019-datacenter-gensecond", 
        "2019-datacenter-core-gensecond", 
        "2019-datacenter-core-smalldisk-gensecond", 
        "2019-datacenter-core-with-containers-gensecond", 
        "2019-datacenter-core-with-containers-smalldisk-g2", 
        "2019-datacenter-smalldisk-gensecond", 
        "2019-datacenter-with-containers-gensecond", 
        "2019-datacenter-with-containers-smalldisk-g2", 
        "2016-datacenter-gensecond"
      ]
      },
      "virtualMachineAdminUserName": {
      "type": "string"
       },
    "virtualMachineAdminPassword": {
      "type": "secureString"
      }
   },        
    "functions": [],
    "variables": {
        "vmnicname": "[concat(parameters('vmname'),'-nic')]",
        "osDiskName":"[concat(parameters('vmname'),'-osDisk')]",
        "DataDiskName":"[concat(parameters('vmname'),'-dataDisk')]",
        "asgid": "[resourceId('Microsoft.Network/applicationSecurityGroups',parameters('applicationSecurityGroups'))]",
        "subnetid": "[parameters('subnetname')]",
        "bootdiagloc": "Germany west central",
        "vaultName": "alf-rsv",
        "backupFabric": "Azure",
        "protectionContainer": "[format('iaasvmcontainer;iaasvmcontainerv2;{0};{1}', resourceGroup().name, parameters('vmname'))]",
        "protectedItem": "[format('vm;iaasvmcontainerv2;{0};{1}', resourceGroup().name, parameters('vmName'))]",
        "backupPolicyName": "defaultpolicy"

    },
     "resources": [
        {
            "name": "[variables('vmnicname')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2020-11-01",
            "dependsOn": [
                "[parameters('applicationSecurityGroups')]"
            ],
            "location": "[resourceGroup().location]",            
            "tags": {
                "displayName": "[variables('vmnicname')]"
            },
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipConfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualnetwork'), variables('subnetid'))]"
                            }                         
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "staticip",
            "dependsOn": [
               "[resourceId('Microsoft.Network/networkInterfaces', variables('vmnicname'))]"
            ],
            "properties": {
                    "mode": "Incremental",
                    "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                     "contentVersion": "1.0.0.0",
                        "resources":[
            {
              "type": "Microsoft.Network/networkInterfaces",
              "name": "[variables('vmnicname')]",
              "apiVersion": "2018-03-01",
              "location": "[resourceGroup().location]",
              "properties": {
                "ipConfigurations": [
                {
                    "name": "ipconfig1",
                    "properties": {
                      "privateIPAllocationMethod": "Static",
                      "privateIPAddress": "[reference(concat(variables('vmnicname'))).ipConfigurations[0].properties.privateIPAddress]",
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualnetwork'), variables('subnetid'))]"
                            },
                            "applicationSecurityGroups": [
                            {
                                "id": "[variables('asgid')]"
                            }
                         ]
                    }                
                } 
                   ]           
               } 
            }                     
                    
            ] 
                                                                
           }
        }
        },
   {
        "type": "Microsoft.Network/applicationSecurityGroups",
        "apiVersion": "2020-11-01",
        "name": "[parameters('applicationSecurityGroups')]",
        "location": "[resourceGroup().location]",
        "tags": {},
        "properties": {}
     },
        {
            "name": "[parameters('vmname')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2021-03-01",
            "location": "[resourceGroup().location]",
            "zones": [
            "[parameters('Zone')]"
            ],
            "dependsOn": [                
                "[resourceId('Microsoft.Network/networkInterfaces', variables('vmnicname'))]"
            ],
            "tags": {
                "displayName": "[parameters('vmname')]"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('vmsize')]"
                },
                "osProfile": {
                    "computerName": "[parameters('vmname')]",
                    "adminUsername": "[parameters('virtualMachineAdminUserName')]",
                    "adminPassword": "[parameters('virtualMachineAdminPassword')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "[parameters('OperatingSystem')]",
                        "version": "latest"
                    },
                    "osDisk": {
                        "name": "[variables('osDiskName')]",
                        "caching": "ReadWrite",
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "[parameters('OSDiskType')]"
                        }
                    },
                    "copy":[
                        {
                        "name":"dataDisks",
                        "count":"[parameters('numberofDatadisks')]",
                        "input":{
                            "lun":"[copyIndex('dataDisks')]",
                            "name":"[concat(variables('DataDiskName'),copyIndex('dataDisks'))]",
                            "createoption":"empty",
                            "caching":"[parameters('dataDiskHostCaching')]",
                            "writeAcceleratorEnabled":"false",
                            "diskSizeGB":"[parameters('datadiskSize')]",
                            "managedDisk":{
                            "storageAccountType":"[parameters('dataDisktype')]"
                        }
                        }
                    }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmnicname'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageaccount')), '2015-06-15').primaryEndpoints.blob]"
                    }
                }
            }
        },
       
        {
            "name": "[concat(parameters('vmname'),'/Diagnostics')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2021-03-01",
            "location": "[resourceGroup().location]",
            "tags": {
                "displayName": "Diagnostics Extension for windowsVM1"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmname'))]"
                
            ],
            "properties": {
                "publisher": "Microsoft.Azure.Diagnostics",
                "type": "IaaSDiagnostics",
                "typeHandlerVersion": "1.5",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "xmlCfg": "[base64('<WadCfg> <DiagnosticMonitorConfiguration overallQuotaInMB=\"4096\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration\"> <DiagnosticInfrastructureLogs scheduledTransferLogLevelFilter=\"Error\"/> <Logs scheduledTransferPeriod=\"PT1M\" scheduledTransferLogLevelFilter=\"Error\" /> <Directories scheduledTransferPeriod=\"PT1M\"> <IISLogs containerName =\"wad-iis-logfiles\" /> <FailedRequestLogs containerName =\"wad-failedrequestlogs\" /> </Directories> <WindowsEventLog scheduledTransferPeriod=\"PT1M\" > <DataSource name=\"Application!*\" /> </WindowsEventLog> <CrashDumps containerName=\"wad-crashdumps\" dumpType=\"Mini\"> <CrashDumpConfiguration processName=\"WaIISHost.exe\"/> <CrashDumpConfiguration processName=\"WaWorkerHost.exe\"/> <CrashDumpConfiguration processName=\"w3wp.exe\"/> </CrashDumps> <PerformanceCounters scheduledTransferPeriod=\"PT1M\"> <PerformanceCounterConfiguration counterSpecifier=\"\\Memory\\Available MBytes\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\Web Service(_Total)\\ISAPI Extension Requests/sec\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\Web Service(_Total)\\Bytes Total/Sec\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\ASP.NET Applications(__Total__)\\Requests/Sec\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\ASP.NET Applications(__Total__)\\Errors Total/Sec\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\ASP.NET\\Requests Queued\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\ASP.NET\\Requests Rejected\" sampleRate=\"PT3M\" /> <PerformanceCounterConfiguration counterSpecifier=\"\\Processor(_Total)\\% Processor Time\" sampleRate=\"PT3M\" /> </PerformanceCounters> </DiagnosticMonitorConfiguration> </WadCfg>')]",
                    "storageAccount": "[parameters('storageaccount')]"
                },
                "protectedSettings": {
                    "storageAccountName": "[parameters('storageaccount')]",
                    "storageAccountKey": "[listkeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageaccount')), '2015-06-15').key1]",
                    "storageAccountEndPoint": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageaccount')), '2015-06-15').primaryEndpoints.blob]"
                }
            }
        },
        {
            "name":"[concat(parameters('vmname'),'/OMSAgent')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2018-10-01",
            "location":"[resourceGroup().location]",
            "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/',parameters('vmname'))]"
            ],
            "properties": {
              "publisher":"Microsoft.EnterpriseCloud.Monitoring",
              "type":"MicrosoftMonitoringAgent",
              "typeHandlerVersion": "1.0",
              "autoUpgradeMinorVersion": true,
              "settings": {
                  "workspaceId":"[parameters('workspaceid')]"
              },
              "protectedSettings":{
                  "workspacekey":"[parameters('workspacekey')]"
              }

            }

        },
    {
      "type": "Microsoft.RecoveryServices/vaults",
      "apiVersion": "2022-01-01",
      "name": "[variables('vaultName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "RS0",
        "tier": "Standard"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
      "apiVersion": "2022-01-01",
      "name": "[format('{0}/{1}/{2}/{3}', variables('vaultName'), variables('backupFabric'), variables('protectionContainer'), variables('protectedItem'))]",
      "properties": {
        "protectedItemType": "Microsoft.Compute/virtualMachines",
        "policyId": "[format('{0}/backupPolicies/{1}', resourceId('Microsoft.RecoveryServices/vaults', variables('vaultName')), variables('backupPolicyName'))]",
        "sourceResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', variables('vaultName'))]",
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
        ]
    }
    ],
        "outputs": {}
}    




    

